name: release

permissions:
  contents: write
  pull-requests: write
  id-token: write

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  verify-release-inputs:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Verify tag matches package versions
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          expected="${TAG_NAME#v}"
          python3 - <<'PY' "$expected"
          import configparser
          import json
          from pathlib import Path
          import sys
          import tomllib

          expected = sys.argv[1]
          cargo = tomllib.loads(Path("Cargo.toml").read_text(encoding="utf-8"))["package"]["version"]
          pkg = json.loads(Path("package.json").read_text(encoding="utf-8"))["version"]
          cfg = configparser.ConfigParser()
          cfg.read("setup.cfg")
          py = cfg["metadata"]["version"]
          versions = {"cargo": cargo, "npm": pkg, "python": py}
          mismatched = {name: value for name, value in versions.items() if value != expected}
          if mismatched:
              raise SystemExit(f"tag version mismatch: expected={expected} actual={mismatched}")
          print(f"tag version verified: {expected}")
          PY
      - name: Verify local hashes are current
        run: |
          set -euo pipefail
          bash scripts/update-local-hashes.sh
          git diff --exit-code -- hashes/local-hashes.json

  publish-rust:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: verify-release-inputs
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - name: Check crates.io for existing version
        id: crate_check
        run: |
          set -euo pipefail
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import tomllib
          import urllib.request

          with open("Cargo.toml", "rb") as handle:
              version = tomllib.load(handle)["package"]["version"]

          exists = False
          try:
              with urllib.request.urlopen("https://crates.io/api/v1/crates/monarchic-agent-protocol") as resp:
                  data = json.load(resp)
              exists = any(v.get("num") == version for v in data.get("versions", []))
          except Exception:
              exists = False

          print(f"exists={'true' if exists else 'false'}")
          PY
      - name: Publish crates.io
        if: steps.crate_check.outputs.exists != 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish

  publish-python:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: verify-release-inputs
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Check PyPI for existing version
        id: pypi_check
        run: |
          set -euo pipefail
          VERSION=$(python - <<'PY'
          import configparser
          cfg = configparser.ConfigParser()
          cfg.read("setup.cfg")
          print(cfg["metadata"]["version"])
          PY
          )
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://pypi.org/pypi/monarchic-agent-protocol/${VERSION}/json || true)
          if [ "$STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Build and publish to PyPI
        if: steps.pypi_check.outputs.exists != 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler
          python -m pip install --upgrade pip build twine protobuf
          protoc -I schemas/v1 --python_out=src/python/monarchic_agent_protocol schemas/v1/monarchic_agent_protocol.proto
          python -m build
          python -m twine upload dist/*

  publish-npm:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: verify-release-inputs
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - name: Check npm for existing version
        id: npm_check
        run: |
          set -euo pipefail
          PKG_VERSION=$(node -p "require('./package.json').version")
          if npm view @monarchic-ai/monarchic-agent-protocol@"${PKG_VERSION}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Debug OIDC env
        run: |
          env | grep ACTIONS_ID_TOKEN || true
      - name: Upgrade npm
        run: |
          npm -v
          npm install -g npm@latest
          npm -v
      - name: Clear npm auth
        run: |
          rm -f ~/.npmrc
          npm config delete //registry.npmjs.org/:_authToken || true
          npm config delete //registry.npmjs.org/:_auth || true
      - name: Publish to npm
        if: steps.npm_check.outputs.exists != 'true'
        run: npm publish --access public --provenance

  publish-dotnet:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: verify-release-inputs
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet restore Monarchic.AgentProtocol.csproj
          dotnet build Monarchic.AgentProtocol.csproj -c Release
          dotnet pack Monarchic.AgentProtocol.csproj -c Release -o ./nupkg
          dotnet nuget push ./nupkg/*.nupkg --api-key "$NUGET_API_KEY" --source https://api.nuget.org/v3/index.json

  publish-ruby:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: verify-release-inputs
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
      - name: Publish to RubyGems
        env:
          GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}
        run: |
          gem build monarchic-agent-protocol.gemspec
          gem push monarchic-agent-protocol-*.gem

  publish-php:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: verify-release-inputs
    steps:
      - name: Trigger Packagist update
        env:
          PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_API_TOKEN: ${{ secrets.PACKAGIST_API_TOKEN }}
        run: |
          curl -sS -X POST \
            "https://packagist.org/api/update-package?username=${PACKAGIST_USERNAME}&apiToken=${PACKAGIST_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"repository":{"url":"https://github.com/monarchic-ai/monarchic-agent-protocol"}}'

  # TODO: pub.dev requires "domain"-based verification through the google console
  # publish-dart:
  #   runs-on: ubuntu-latest
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dart-lang/setup-dart@v1
  #       with:
  #         sdk: stable
  #     - name: Publish to pub.dev
  #       env:
  #         PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}
  #       run: |
  #         dart pub publish --force


  open-registry-hash-pr:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - publish-rust
      - publish-python
      - publish-npm
      - publish-dotnet
      - publish-ruby
      - publish-php
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Refresh registry hash manifest (retry strict, fallback partial)
        id: refresh_hashes
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          strict_ok=0
          for attempt in 1 2 3 4 5 6; do
            if bash scripts/update-registry-hashes.sh --tag "$TAG_NAME"; then
              strict_ok=1
              break
            fi
            echo "registry hash refresh strict attempt $attempt failed; retrying"
            sleep 20
          done
          if [ "$strict_ok" -eq 1 ]; then
            echo "partial=false" >> "$GITHUB_OUTPUT"
          else
            bash scripts/update-registry-hashes.sh --tag "$TAG_NAME" --allow-missing
            echo "partial=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update registry hash PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ci/registry-hashes-${{ github.ref_name }}
          base: main
          title: "chore(release): update registry hashes for ${{ github.ref_name }}"
          commit-message: "chore(release): update registry hashes for ${{ github.ref_name }}"
          body: |
            Automated post-tag registry hash refresh for `${{ github.ref_name }}`.

            Partial refresh: `${{ steps.refresh_hashes.outputs.partial }}`

            Generated by:
            - `scripts/update-registry-hashes.sh --tag ${{ github.ref_name }}`
          labels: |
            automation
            release
          add-paths: |
            hashes/registry-hashes.json
