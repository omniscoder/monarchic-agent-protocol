name: release

permissions:
  contents: read
  id-token: write

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  publish-rust:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - name: Check crates.io for existing version
        id: crate_check
        run: |
          set -euo pipefail
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import tomllib
          import urllib.request

          with open("Cargo.toml", "rb") as handle:
              version = tomllib.load(handle)["package"]["version"]

          exists = False
          try:
              with urllib.request.urlopen("https://crates.io/api/v1/crates/monarchic-agent-protocol") as resp:
                  data = json.load(resp)
              exists = any(v.get("num") == version for v in data.get("versions", []))
          except Exception:
              exists = False

          print(f"exists={'true' if exists else 'false'}")
          PY
      - name: Publish crates.io
        if: steps.crate_check.outputs.exists != 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish

  publish-python:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Check PyPI for existing version
        id: pypi_check
        run: |
          set -euo pipefail
          VERSION=$(python - <<'PY'
          import configparser
          cfg = configparser.ConfigParser()
          cfg.read("setup.cfg")
          print(cfg["metadata"]["version"])
          PY
          )
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://pypi.org/pypi/monarchic-agent-protocol/${VERSION}/json || true)
          if [ "$STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Build and publish to PyPI
        if: steps.pypi_check.outputs.exists != 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler
          python -m pip install --upgrade pip build twine protobuf
          protoc -I schemas/v1 --python_out=src/python/monarchic_agent_protocol schemas/v1/monarchic_agent_protocol.proto
          python -m build
          python -m twine upload dist/*

  publish-npm:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - name: Check npm for existing version
        id: npm_check
        run: |
          set -euo pipefail
          PKG_VERSION=$(node -p "require('./package.json').version")
          if npm view @monarchic-ai/monarchic-agent-protocol@"${PKG_VERSION}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Debug OIDC env
        run: |
          env | grep ACTIONS_ID_TOKEN || true
      - name: Upgrade npm
        run: |
          npm -v
          npm install -g npm@latest
          npm -v
      - name: Clear npm auth
        run: |
          rm -f ~/.npmrc
          npm config delete //registry.npmjs.org/:_authToken || true
          npm config delete //registry.npmjs.org/:_auth || true
      - name: Publish to npm
        if: steps.npm_check.outputs.exists != 'true'
        run: npm publish --access public --provenance

  publish-dotnet:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet restore Monarchic.AgentProtocol.csproj
          dotnet build Monarchic.AgentProtocol.csproj -c Release
          dotnet pack Monarchic.AgentProtocol.csproj -c Release -o ./nupkg
          dotnet nuget push ./nupkg/*.nupkg --api-key "$NUGET_API_KEY" --source https://api.nuget.org/v3/index.json

  publish-ruby:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
      - name: Publish to RubyGems
        env:
          GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}
        run: |
          gem build monarchic-agent-protocol.gemspec
          gem push monarchic-agent-protocol-*.gem

  publish-php:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Trigger Packagist update
        env:
          PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_API_TOKEN: ${{ secrets.PACKAGIST_API_TOKEN }}
        run: |
          curl -sS -X POST \
            "https://packagist.org/api/update-package?username=${PACKAGIST_USERNAME}&apiToken=${PACKAGIST_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"repository":{"url":"https://github.com/monarchic-ai/monarchic-agent-protocol"}}'

  # TODO: pub.dev requires "domain"-based verification through the google console
  # publish-dart:
  #   runs-on: ubuntu-latest
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dart-lang/setup-dart@v1
  #       with:
  #         sdk: stable
  #     - name: Publish to pub.dev
  #       env:
  #         PUB_CREDENTIALS: ${{ secrets.PUB_CREDENTIALS }}
  #       run: |
  #         dart pub publish --force

  update-registry-hashes:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - publish-rust
      - publish-python
      - publish-npm
      - publish-dotnet
      - publish-ruby
      - publish-php
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: cachix/install-nix-action@v27
      - name: Wait for registries to publish
        env:
          TAG_REF: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${TAG_REF#v}"
          urls=(
            "npm|https://registry.npmjs.org/@monarchic-ai/monarchic-agent-protocol/-/monarchic-agent-protocol-${VERSION}.tgz"
            "crates|https://crates.io/api/v1/crates/monarchic-agent-protocol/${VERSION}/download"
            "pypi|https://files.pythonhosted.org/packages/source/m/monarchic_agent_protocol/monarchic_agent_protocol-${VERSION}.tar.gz"
            "rubygems|https://rubygems.org/downloads/monarchic-agent-protocol-${VERSION}.gem"
            "nuget|https://api.nuget.org/v3-flatcontainer/monarchic.agentprotocol/${VERSION}/monarchic.agentprotocol.${VERSION}.nupkg"
            "jitpack|https://jitpack.io/com/github/monarchic-ai/monarchic-agent-protocol/v${VERSION}/monarchic-agent-protocol-v${VERSION}.jar"
            "github|https://github.com/monarchic-ai/monarchic-agent-protocol/archive/v${VERSION}.tar.gz"
          )
          max_attempts=20
          attempt=1
          while true; do
            echo "Attempt ${attempt}/${max_attempts}..."
            missing=0
            for item in "${urls[@]}"; do
              name="${item%%|*}"
              url="${item#*|}"
              if curl -fsSL -o /dev/null "$url"; then
                echo "  ok: ${name}"
              else
                echo "  waiting: ${name}"
                missing=$((missing+1))
              fi
            done
            if [ "$missing" -eq 0 ]; then
              echo "All registries available"
              break
            fi
            if [ "$attempt" -ge "$max_attempts" ]; then
              echo "Timed out waiting for registries" >&2
              exit 1
            fi
            sleep_time=$((10 * 2 ** (attempt - 1)))
            if [ "$sleep_time" -gt 300 ]; then sleep_time=300; fi
            echo "Sleeping ${sleep_time}s"
            sleep "$sleep_time"
            attempt=$((attempt+1))
          done
      - name: Update registry hashes
        run: nix run .#update-registry-hashes
      - name: Commit updated hashes
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add flake.nix
          git commit -m "chore: update registry hashes [ci skip]"
          git push origin HEAD:main

